{% extends "base.html" %}

{% block title %}Verify OTP{% endblock %}

{% block content %}
<div class="card fade-in">
    <div class="card-header">
        <div style="width: 60px; height: 60px; margin: 0 auto var(--space-4); background: var(--primary-light); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-lock" style="font-size: 1.75rem; color: var(--primary);"></i>
        </div>
        <h1>Verify Your Number</h1>
        <p style="margin-bottom: var(--space-2);">
            We sent a 6-digit code to<br>
            <strong style="color: var(--text-primary); font-size: 1.125rem;">+91 {{ mobile }}</strong>
        </p>
    </div>
    
    <form id="otp-form">
        {% csrf_token %}
        <input type="hidden" name="mobile" value="{{ mobile }}">
        
        <div class="form-group">
            <label for="otp" class="required">Enter Verification Code</label>
            <input 
                type="text" 
                id="otp" 
                name="otp" 
                placeholder="• • • • • •" 
                required 
                maxlength="6"
                inputmode="numeric"
                pattern="[0-9]{6}"
                style="letter-spacing: 0.5em; font-size: 1.5rem; text-align: center; font-weight: 600;"
                autocomplete="one-time-code"
            >
            <div class="error-text" id="otp-error" style="display: none;"></div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block btn-lg" id="verify-btn">
            <i class="fa-solid fa-check-circle"></i>
            Verify & Continue
        </button>
        
        <div style="text-align: center; margin-top: var(--space-4);">
            <p class="text-muted" style="margin-bottom: var(--space-2); font-size: 0.875rem;">
                Didn't receive the code?
            </p>
            <button type="button" class="btn btn-ghost btn-sm" id="resend-btn" disabled>
                <i class="fa-solid fa-rotate"></i>
                <span id="resend-text">Resend in <span id="countdown">30</span>s</span>
            </button>
        </div>
    </form>
</div>

<div style="text-align: center;">
    <a href="{% url 'mobile_login' %}" class="link-back">
        <i class="fa-solid fa-arrow-left"></i> Change Mobile Number
    </a>
</div>

<script>
$(document).ready(function() {
    const $form = $('#otp-form');
    const $otp = $('#otp');
    const $error = $('#otp-error');
    const $btn = $('#verify-btn');
    const $resendBtn = $('#resend-btn');
    const $countdown = $('#countdown');
    const mobile = $('[name=mobile]').val();
    
    // Auto-focus OTP field
    $otp.focus();
    
    // Only allow numbers
    $otp.on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        $error.hide().text('');
        
        // Auto-submit when 6 digits entered
        if (this.value.length === 6) {
            $form.submit();
        }
    });
    
    // Resend countdown timer
    let countdown = 30;
    const timer = setInterval(function() {
        countdown--;
        $countdown.text(countdown);
        
        if (countdown <= 0) {
            clearInterval(timer);
            $resendBtn.prop('disabled', false);
            $('#resend-text').html('<span>Resend Code</span>');
        }
    }, 1000);
    
    // Resend OTP
    $resendBtn.on('click', function() {
        $(this).prop('disabled', true);
        
        $.ajax({
            url: '{% url "mobile_login" %}',
            method: 'POST',
            data: {
                mobile: mobile,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    $error.removeClass('error-text').css('color', 'var(--success)').html('<i class="fa-solid fa-circle-check"></i> New code sent!').show();
                    setTimeout(() => $error.hide(), 3000);
                    
                    // Reset countdown
                    countdown = 30;
                    $countdown.text(countdown);
                    $('#resend-text').html('Resend in <span id="countdown">30</span>s');
                }
            },
            error: function() {
                $resendBtn.prop('disabled', false);
            }
        });
    });
    
    // Form submission
    $form.on('submit', function(e) {
        e.preventDefault();
        
        const otp = $otp.val().trim();
        $error.hide().text('');
        
        // Validation
        if (otp.length !== 6) {
            $error.html('<i class="fa-solid fa-circle-exclamation"></i> Please enter a 6-digit code').show();
            $otp.focus();
            return;
        }
        
        if (!/^\d{6}$/.test(otp)) {
            $error.html('<i class="fa-solid fa-circle-exclamation"></i> Code must contain only numbers').show();
            $otp.focus();
            return;
        }
        
        // Disable button and show loading
        const originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<div class="spinner"></div> Verifying...');
        
        // Submit via AJAX
        $.ajax({
            url: '{% url "verify_otp" %}',
            method: 'POST',
            data: {
                mobile: mobile,
                otp: otp,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Success - redirect
                    $btn.html('<i class="fa-solid fa-circle-check"></i> Verified!');
                    setTimeout(() => {
                        window.location.href = response.redirect;
                    }, 500);
                } else {
                    // Show error
                    $error.html('<i class="fa-solid fa-circle-exclamation"></i> ' + (response.message || 'Invalid code. Please try again')).show();
                    $btn.prop('disabled', false).html(originalHtml);
                    $otp.val('').focus();
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON || {};
                $error.html('<i class="fa-solid fa-circle-exclamation"></i> ' + (response.message || 'Verification failed. Please try again')).show();
                $btn.prop('disabled', false).html(originalHtml);
                $otp.val('').focus();
            }
        });
    });
});
</script>
{% endblock %}